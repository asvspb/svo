# Testing Guide

## Принципы
- Пирамида тестирования: больше unit, меньше e2e; критичные пути — интеграционные.
- Тесты должны быть быстрыми, детерминированными, изолированными.

## Инструменты
- pytest — основной фреймворк.
- coverage — контроль покрытия; цель: >80% для доменной логики.
- mock/fixtures — изоляция внешних API, работы с сетью и диском.

## Практики
- Структура `tests/` повторяет `src/`.
- Именование: `test_<module>_<behavior>.py`, тесты — «arrange/act/assert».
- Фикстуры для общих сетапов; избегайте скрытой магии в фикстурах.

## Гео-данные: тестирование
- Фикстуры с маленькими GeoJSON (валидные и с ошибками) для проверки валидации и вычислений.
- Всегда указывайте и проверяйте CRS; для площадей — переводите в равновеликую проекцию перед ассертом.
- Сравнение площадей и координат — с допуском (tolerance), а не побитово.
- Тестируйте кейсы: пересечение, отсутствие пересечения, саморазрывы и исправление геометрий.

## Playwright: тестирование
- Юнит-тестируйте обработчики сетевых ответов и парсеры — изолированно от браузера.
- Для интеграционных тестов запускайте headless + `xvfb` на CI; помечайте e2e как `slow` и запускайте по расписанию/по метке.
- Стабилизируйте ожидания: `wait_for_response` с предикатом/таймаутом, избегайте «голого» sleep.
- Мокайте ответы API (playwright route/fulfill) для устойчивых тестов без внешней сети.

## Telegram-бот: тестирование
- Юнит-тестируйте бизнес-логику и форматирование сообщений отдельно от Telegram API.
- Используйте тестовые утилиты/моки (например, из aiogram) для эмуляции апдейтов и проверки хендлеров.
- Тестируйте идемпотентность, обработку ошибок и таймауты при сетевых сбоях.

## CI
- Запускайте pytest с флагами предупреждений и генерацией отчета покрытия.
- Публикуйте артефакты отчета покрытия.
- Выносите e2e/браузерные тесты в отдельную джобу/выполнение по расписанию.
