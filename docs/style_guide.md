# Style Guide (Python)

## Форматирование и стиль
- PEP 8 для форматирования, PEP 257 для докстрингов.
- Используйте black (формат), isort (импорты), ruff/flake8 (линтинг).
- Длина строки: 100–120 символов (согласуется на проекте).
- Именование: snake_case — функции/переменные; PascalCase — классы; UPPER_CASE — константы.
- Избегайте «магических чисел»: выносите в именованные константы.
- Комментарии — по делу. TODO с контекстом и владельцем: `TODO(username): что и зачем`.

## Типизация и контракты
- Аннотируйте функции и публичные интерфейсы (PEP 484/561).
- Явно указывайте Optional и точные типы коллекций (`list[str]`, `dict[str, Any]`).
- Поддерживайте докстринги в стиле Google/Numpy или reST: Args, Returns, Raises, Examples.
- Запускайте mypy/pyright в строгом режиме на CI.

## Организация модулей
- Разделяйте слои: IO (внешние источники), доменная логика, представление (репорты), интерфейсы (бот/CLI).
- Адаптеры для внешних API: изоляция от доменной логики, стабильные контракты.

## Гео-данные (проектная специфика)
- Всегда указывайте CRS (Coordinate Reference System) для GeoDataFrame; храните в EPSG:4326, для площадей — преобразуйте в равновеликие CRS (например, EPSG:6933) перед вычислениями.
- Геометрия — через shapely/geopandas, не «вручную»; проверяйте валидность геометрий (`gdf.is_valid`) и исправляйте (`buffer(0)`).
- Валидация входных GeoJSON: схема (обязательные поля), sanity-check (диапазоны площадей/координат, отсутствие самопересечений).
- Операции различий: используйте overlay/difference/symmetric_difference осознанно; документируйте допущения при вычитании.
- Нормализуйте топонимы и направления (справочники), храните единые enum-значения статусов (оккупировано/серая зона и т.д.).

## Playwright (Scraper)
- Антибот-практики: параметризуемый `headless`, случайный User-Agent, адекватные тайминги, не спамить запросами.
- Ожидание: избегайте фиксированных `sleep`; используйте `wait_for_load_state`, ожидание конкретных сетевых ответов/селекторов, `page.wait_for_response` с предикатом.
- Перехват сети: фильтруйте по content-type и предсказуемым путям; логируйте URL, статус, размер для диагностики.
- Ошибки: не глушите исключения; добавляйте контекст (какой URL/эндпоинт), ретраи c экспонентой и джиттером.
- Конфиг: эндпоинты, таймауты, селекторы и user-agent — в конфигурации, а не в коде.
- Сохранение артефактов: складывайте JSON в `data/YYYY/MM/`, протоколы/скриншоты — в `logs/` или `artifacts/`.

## Telegram-бот (aiogram/python-telegram-bot)
- Архитектура: разнесите инициализацию бота, регистрацию хендлеров, бизнес-логику и планировщик.
- Хендлеры: маленькие, чистые; всю логику выносите в сервисы/юзкейсы. Ограничивайте сайд-эффекты.
- FSM/состояния: используйте для многошаговых сценариев; храните состояние в памяти/БД по необходимости.
- Rate limiting и идемпотентность: защищайтесь от дублей и спама пользователей.
- Конфигурация токенов и списков админов — через переменные окружения; не хардкодьте ID.

## Конфигурация окружений
- .env для локалки, переменные окружения — для CI/прод.
- Схема конфигурации — через pydantic-settings; валидируйте обязательные поля при старте.
- Разделяйте профили: `dev`, `test`, `prod` (разные таймауты, лог-уровни, endpoints).

## Данные и каталоги
- Стандартизируйте пути: `data/` для входов/выходов, `logs/` для логов, `artifacts/` для скриншотов/репортов.
- Именование файлов данных: `deepstate_YYYY_MM_DD.json`; не затирайте, используйте версионирование по дате.
